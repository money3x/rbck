const ProviderFactory = require('../providers/factory/ProviderFactory');
const { getEnabledProviders } = require('../providers/config/providers.config');

class SwarmCouncil {
    constructor() {
        this.providers = {};
        this.roles = {};
        this.isInitialized = false;
        this.initializeSwarm();
    }
    
    initializeSwarm() {
        try {
            const enabledProviders = getEnabledProviders();
            console.log('ü§ñ [Swarm] Initializing AI Swarm Council...');
            
            Object.entries(enabledProviders).forEach(([providerName, config]) => {
                try {
                    // Create provider instance
                    const provider = ProviderFactory.createProvider(providerName);
                    
                    // Set role and context
                    provider.setRole(config.role);
                    provider.setSpecialties(config.specialties);
                    provider.setCouncilContext(this);
                    
                    this.providers[providerName] = provider;
                    this.roles[config.role] = providerName;
                    
                    console.log(`‚úÖ [Swarm] ${config.name} initialized as ${config.role}`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è [Swarm] Failed to initialize ${providerName}:`, error.message);
                }
            });
            
            this.isInitialized = true;
            console.log(`üéØ [Swarm] Council initialized with ${Object.keys(this.providers).length} active members`);
            
        } catch (error) {
            console.error('‚ùå [Swarm] Initialization failed:', error);
            this.isInitialized = false;
        }
    }
    
    async processContent(prompt, workflow = 'full') {
        if (!this.isInitialized) {
            throw new Error('Swarm Council not properly initialized');
        }
        
        const result = {
            originalPrompt: prompt,
            workflow: workflow,
            steps: [],
            finalContent: null,
            metadata: {
                timestamp: new Date().toISOString(),
                participatingProviders: Object.keys(this.providers),
                workflowType: workflow
            }
        };
        
        try {
            console.log(`üéØ [Swarm] Starting ${workflow} workflow for: "${prompt.substring(0, 50)}..."`);
            
            switch (workflow) {
                case 'full':
                    return await this.fullSwarmWorkflow(prompt, result);
                case 'create':
                    return await this.creationWorkflow(prompt, result);
                case 'review':
                    return await this.reviewWorkflow(prompt, result);
                case 'optimize':
                    return await this.optimizationWorkflow(prompt, result);
                default:
                    throw new Error(`Unknown workflow: ${workflow}`);
            }
        } catch (error) {
            console.error('‚ùå [Swarm] Processing error:', error);
            result.error = error.message;
            result.status = 'failed';
            return result;
        }
    }
    
    async fullSwarmWorkflow(prompt, result) {
        console.log('üîÑ [Swarm] Executing full council workflow...');
        
        // Step 1: Content Creation
        if (this.providers.gemini) {
            console.log('üìù [Swarm] Step 1: Content Creation (Gemini)');
            const creationPrompt = `${prompt}\n\nRole: ‡∏ô‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°`;
            const createdContent = await this.providers.gemini.generateContent(creationPrompt);
            
            result.steps.push({
                step: 1,
                role: '‡∏ô‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å',
                provider: 'gemini',
                output: createdContent,
                timestamp: new Date().toISOString()
            });
            result.finalContent = createdContent;
        }
        
        // Step 2: Quality Review
        if (this.providers.openai && result.finalContent) {
            console.log('üîç [Swarm] Step 2: Quality Review (OpenAI)');
            const reviewPrompt = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n\n${result.finalContent}\n\nRole: ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°`;
            const reviewedContent = await this.providers.openai.generateContent(reviewPrompt);
            
            result.steps.push({
                step: 2,
                role: '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û',
                provider: 'openai',
                output: reviewedContent,
                timestamp: new Date().toISOString()
            });
            result.finalContent = reviewedContent;
        }
        
        // Step 3: Content Enhancement
        if (this.providers.claude && result.finalContent) {
            console.log('‚ú® [Swarm] Step 3: Content Enhancement (Claude)');
            const enhancePrompt = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n\n${result.finalContent}\n\nRole: ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô`;
            const enhancedContent = await this.providers.claude.generateContent(enhancePrompt);
            
            result.steps.push({
                step: 3,
                role: '‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤',
                provider: 'claude',
                output: enhancedContent,
                timestamp: new Date().toISOString()
            });
            result.finalContent = enhancedContent;
        }
        
        // Step 4: Technical Review
        if (this.providers.deepseek && result.finalContent) {
            console.log('üî¨ [Swarm] Step 4: Technical Review (DeepSeek)');
            const techPrompt = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n\n${result.finalContent}\n\nRole: ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û`;
            const techReview = await this.providers.deepseek.generateContent(techPrompt);
            
            result.steps.push({
                step: 4,
                role: '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ',
                provider: 'deepseek',
                output: techReview,
                timestamp: new Date().toISOString()
            });
            result.finalContent = techReview;
        }
        
        // Step 5: Cultural Optimization
        if (this.providers.chinda && result.finalContent) {
            console.log('üáπüá≠ [Swarm] Step 5: Cultural Optimization (ChindaX)');
            const culturalPrompt = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n\n${result.finalContent}\n\nRole: ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏†‡∏≤‡∏©‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°`;
            const culturalOptimized = await this.providers.chinda.generateContent(culturalPrompt);
            
            result.steps.push({
                step: 5,
                role: '‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏†‡∏≤‡∏©‡∏≤',
                provider: 'chinda',
                output: culturalOptimized,
                timestamp: new Date().toISOString()
            });
            result.finalContent = culturalOptimized;
        }
        
        result.status = 'completed';
        console.log(`‚úÖ [Swarm] Full workflow completed with ${result.steps.length} steps`);
        return result;
    }
    
    async creationWorkflow(prompt, result) {
        console.log('üìù [Swarm] Executing creation workflow...');
        
        if (this.providers.gemini) {
            const content = await this.providers.gemini.generateContent(
                `${prompt}\n\nRole: ‡∏ô‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å - ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û`
            );
            
            result.steps.push({
                step: 1,
                role: '‡∏ô‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å',
                provider: 'gemini',
                output: content,
                timestamp: new Date().toISOString()
            });
            result.finalContent = content;
        }
        
        result.status = 'completed';
        return result;
    }
    
    async reviewWorkflow(prompt, result) {
        console.log('üîç [Swarm] Executing review workflow...');
        
        if (this.providers.openai) {
            const review = await this.providers.openai.generateContent(
                `${prompt}\n\nRole: ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û - ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå`
            );
            
            result.steps.push({
                step: 1,
                role: '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û',
                provider: 'openai',
                output: review,
                timestamp: new Date().toISOString()
            });
            result.finalContent = review;
        }
        
        result.status = 'completed';
        return result;
    }
    
    async optimizationWorkflow(prompt, result) {
        console.log('‚ö° [Swarm] Executing optimization workflow...');
        
        if (this.providers.claude) {
            const optimized = await this.providers.claude.generateContent(
                `${prompt}\n\nRole: ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤`
            );
            
            result.steps.push({
                step: 1,
                role: '‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤',
                provider: 'claude',
                output: optimized,
                timestamp: new Date().toISOString()
            });
            result.finalContent = optimized;
        }
        
        result.status = 'completed';
        return result;
    }
    
    getCouncilStatus() {
        const status = {
            initialized: this.isInitialized,
            totalMembers: Object.keys(this.providers).length,
            activeMembers: {},
            roles: {},
            capabilities: []
        };
        
        Object.entries(this.providers).forEach(([name, provider]) => {
            status.activeMembers[name] = {
                available: true,
                role: provider.role || 'Unknown',
                specialties: provider.specialties || []
            };
        });
        
        Object.entries(this.roles).forEach(([role, provider]) => {
            status.roles[role] = provider;
        });
        
        status.capabilities = [
            'full', 'create', 'review', 'optimize'
        ];
        
        return status;
    }
    
    async consultMember(memberRole, question) {
        const memberProvider = this.roles[memberRole];
        if (!memberProvider || !this.providers[memberProvider]) {
            throw new Error(`No member found with role: ${memberRole}`);
        }
        
        return await this.providers[memberProvider].generateContent(question);
    }
}

module.exports = SwarmCouncil;
